# Cloud Computing: Servicios y aplicaciones.
# P2: Uso de contenedores Docker
# Gustavo Rivas Gervilla. gustavofox92@correo.ugr.es

## Enunciado

**El	objetivo	 de	esta	práctica	es	familiarizarse	con	el	uso	de	un	sistema	de	gestión	de	bases	de
datos	 en	 entornos	 Big	 Data.	 Para	 ello,	 haremos	 uso	 de	 la	 aplicación	 más	 conocida	 como	 es
MongoDB.**

**Para	constatar	el	manejo	de	la	herramienta	anterior,	el	alumno	deberá	realizar	las	tareas	que
se	describen	a	continuación	y	entregar	documentación	describiendo	las	tareas	realizadas.**

## Objetivo1

Para hacer la experimentación vamos a crear un contenedor docker en el servidor *hadoop.ugr.es* con la imagen Alpine, un S.O. muy ligero y de uso muy extendido para desarrollar contenedores Docker. Para ello empleamos la siguiente orden: `docker run -d --name mongo_griger -p 14089:27017 mvertes/alpine-mongo`. A continuación accedemos al contenedor que acabamos de crear empleando la instrucción `docker exec -ti mongo_griger sh`.

Para copiar el script JavaScript desde el host al contenedor lo que hacemos, desde el directorio **/tmp/mongo** ejecutar el comando siguiente: `docker exec -i mongo_griger sh -c 'cat > /data/db/insertar_pedidos.js' < insertar_pedidos.js`. Se ha tratado de emplear el comando `docker cp` pero la versión de Docker que hay instalada en el servidor Hadoop parece que no permite copiar un archivo desde el host al contenedor con ese comando.

Señalar que guardamos el script en el directorio **/data/db** porque es que el tiene MongoDB configurado por defecto para los scripts, podríamos haberlo guardado en otro directorio cualquiera.

Una vez hemos ejecutado el el script con la orden `load("insertar_pedidos.js")` (importante poner el nombre del script entre comillas) dentro de la terminal de mongo (a la que accedemos con el comando `mongo`) comprobamos, en la misma consola, que se ha creado la colección con el comando `db.getCollectionNames()`.

### 1. Visualiza la colección pedidos y familiarízate con ella. Observa los distintos tipos de datos y sus estructuras dispares.

La colección se ha creado dentro de la base de datos *test* del contenedor Mongo que es la que se está usando en este momento, si quisiéramos pasar a usar otra, y que por tanto los comando del tipo `db.comando` se ejecutasen sobre ella, usaríamos el comando `use nombreBD`. Entonces si ahora queremos lista el contenido de esta colección no tenemos más que ejecutar el comando `db.pedidos.find()`, no especificamos ningún parámetro dentro de la función `find` ya que queremos todos los documentos de la colección y no filtrarlos. Con esto tenemos la siguiente:

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb377f"), "id_cliente" : 1111, "Nombre" : "Pedro Ramirez", "Direccion" : "Calle Los Romeros 14", "Localidad" : "Sevilla", "Fnacimiento" : ISODate("1963-04-03T00:00:00Z"), "Facturacion" : 5000, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 390, "Cantidad" : 1 }, { "id_producto" : 2, "Nombre" : "Tablet 8 pulgadas", "Precio_unidad" : 95, "Cantidad" : 1 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 115, "Cantidad" : 3 } ] } ] }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3780"), "id_cliente" : 2222, "Nombre" : "Juan Gomez", "Direccion" : "Perpetuo Socorro 9", "Localidad" : "Salamanca", "Fnacimiento" : ISODate("1960-08-17T00:00:00Z"), "Facturacion" : 6500, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 100, "Cantidad" : 1 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Fabricante" : "Intel", "Precio_unidad" : 455, "Cantidad" : 2 }, { "id_producto" : 27, "Nombre" : "Cable USB", "Precio_unidad" : 11, "Cantidad" : 12 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 128, "Cantidad" : 3 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Fabricante" : "Intel", "Precio_unidad" : 451, "Cantidad" : 5 }, { "id_producto" : 21, "Nombre" : "Disco Duro 500GB", "Precio_unidad" : 99, "Cantidad" : 10 } ] }, { "id_pedido" : 3, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 94, "Cantidad" : 5 }, { "id_producto" : 95, "Nombre" : "SAI 5H Mod. 258", "Precio_unidad" : 213, "Cantidad" : 2 }, { "id_producto" : 21, "Precio_unidad" : 66, "Nombre" : "Disco Duro 500GB", "Cantidad" : 10 } ] } ] }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3781"), "id_cliente" : 3333, "Nombre" : "Carlos Montes", "Direccion" : "Salsipuedes 13", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1967-11-25T00:00:00Z"), "Facturacion" : 8000 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3782"), "id_cliente" : 4444, "Nombre" : "Carmelo Coton", "Direccion" : "La Luna 103", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1969-01-06T00:00:00Z"), "Facturacion" : 12300 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3783"), "id_cliente" : 5555, "Nombre" : "Cristina Miralles", "Direccion" : "San Fernando 28", "Localidad" : "Granada", "Fnacimiento" : ISODate("1970-07-12T00:00:00Z"), "Facturacion" : 16500, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 95, "Nombre" : "SAI 5H Mod. 258", "Precio_unidad" : 211, "Cantidad" : 2 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Precio_unidad" : 460, "Fabricante" : "Intel", "Cantidad" : 2 }, { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 119, "Cantidad" : 2 } ] } ] }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3784"), "id_cliente" : 6666, "Nombre" : "Chema Pamundi", "Direccion" : "Recogidas 54", "Localidad" : "Granada", "Fnacimiento" : ISODate("1969-02-04T00:00:00Z"), "Facturacion" : 5000 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3785"), "id_cliente" : 777, "Nombre" : "Alberto Matero", "Direccion" : "Pelayo 4", "Localidad" : "Sevilla", "Facturacion" : 2500, "Pedidos" : null }
```

Lo primero que se observa es que cada documento es un array de elementos clave-valor, el valor asociado a cada clave puede ser de diverso tipo: cadenas de texto, enteros, fechas con formato, arrays, arrays asociativos, etc.

Por otro lado vemos que no todos los objetos han de seguir el mismo esquema, por ejemplo dentro de los pedidos hay productos que tienen un campo que es el fabricante y otros no, como el Disco Duro 500GB. También hay clientes que no poseen un array de pedidos.

### 2. Visualiza sólo el primer documento de la colección. Utiliza los métodos .limit() y .findOne()

El resultado de ambas consultas varía simplemente en el formato. Mientras que con `db.pedidos.find().limit(1)` lo obtenemos todo en una línea de texto, como obteníamos el contenido completo de la colección:

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb377f"), "id_cliente" : 1111, "Nombre" : "Pedro Ramirez", "Direccion" : "Calle Los Romeros 14", "Localidad" : "Sevilla", "Fnacimiento" : ISODate("1963-04-03T00:00:00Z"), "Facturacion" : 5000, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 390, "Cantidad" : 1 }, { "id_producto" : 2, "Nombre" : "Tablet 8 pulgadas", "Precio_unidad" : 95, "Cantidad" : 1 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 115, "Cantidad" : 3 } ] } ] }
```

En cambio con `db.pedidos.findOne()` la salida se formatea mejor, separando los campos para que sea más cómoda su lectura:

```JavaScript
{
	"_id" : ObjectId("58ff8df7dcc0e5e22fdb377f"),
	"id_cliente" : 1111,
	"Nombre" : "Pedro Ramirez",
	"Direccion" : "Calle Los Romeros 14",
	"Localidad" : "Sevilla",
	"Fnacimiento" : ISODate("1963-04-03T00:00:00Z"),
	"Facturacion" : 5000,
	"Pedidos" : [
		{
			"id_pedido" : 1,
			"Productos" : [
				{
					"id_producto" : 1,
					"Nombre" : "Pentium IV",
					"Fabricante" : "Intel",
					"Precio_unidad" : 390,
					"Cantidad" : 1
				},
				{
					"id_producto" : 2,
					"Nombre" : "Tablet 8 pulgadas",
					"Precio_unidad" : 95,
					"Cantidad" : 1
				}
			]
		},
		{
			"id_pedido" : 2,
			"Productos" : [
				{
					"id_producto" : 77,
					"Nombre" : "Impresora Laser",
					"Fabricante" : "Canon",
					"Precio_unidad" : 115,
					"Cantidad" : 3
				}
			]
		}
	]
}
```
### 3. Visualiza el cliente con id_cliente = 2222

Para esto haremos uso de nuevo de la función `find` pero esta vez sí le especificaremos como argumento el filtro a aplicar sobre la colección, `db.pedidos.find({id_cliente : 2222})`:

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3780"), "id_cliente" : 2222, "Nombre" : "Juan Gomez", "Direccion" : "Perpetuo Socorro 9", "Localidad" : "Salamanca", "Fnacimiento" : ISODate("1960-08-17T00:00:00Z"), "Facturacion" : 6500, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 100, "Cantidad" : 1 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Fabricante" : "Intel", "Precio_unidad" : 455, "Cantidad" : 2 }, { "id_producto" : 27, "Nombre" : "Cable USB", "Precio_unidad" : 11, "Cantidad" : 12 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 128, "Cantidad" : 3 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Fabricante" : "Intel", "Precio_unidad" : 451, "Cantidad" : 5 }, { "id_producto" : 21, "Nombre" : "Disco Duro 500GB", "Precio_unidad" : 99, "Cantidad" : 10 } ] }, { "id_pedido" : 3, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 94, "Cantidad" : 5 }, { "id_producto" : 95, "Nombre" : "SAI 5H Mod. 258", "Precio_unidad" : 213, "Cantidad" : 2 }, { "id_producto" : 21, "Precio_unidad" : 66, "Nombre" : "Disco Duro 500GB", "Cantidad" : 10 } ] } ] }
```
### 4. Visualiza los clientes que hayan pedido algún producto de más de 94 euros

Para esta consulta vamos a hacer uso del operador $elemMatch que nos daría una consulta con resultado verdades si el campo, de tipo array, sobre el que realizamos la consulta contiene al menos un elemento que cumpla las restricciones que le imponemos. Ya que se trata de un campo que contiene un array de documentos, que a su vez, cada uno de ellos, contiene un array de documentos, tendremos que hacer uso de este operador dos veces.

```JavaScript
db.pedidos.find(
   {Pedidos :
     {$elemMatch :
       {Productos : {$elemMatch : {Precio_unidad : {$gt : 94} } } }
     }
   },
   {id_cliente : true}
)
```

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb377f"), "id_cliente" : 1111 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3780"), "id_cliente" : 2222 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3783"), "id_cliente" : 5555 }
```

### 5. Visualiza los clientes de Jaén o Salamanca (excluye los datos de los pedidos). Utiliza los operadores $or e $in.

Con este ejercicio se pone de manifiesto que una misma consulta puede realizarse de distintas maneras, en esta ocasión usando el operador `$or` o el operador `$in`.

```JavaScript
db.pedidos.find(
  {$or : [{Localidad : "Jaen"}, {Localidad : "Salamanca"}]},
  {Pedidos : false}
)
```
También se observa lo cómo que resulta realizar una proyección en MongoDB, si en la lista especificamos que un elemento se excluye el resto se asume que se han de mostrar. Del mismo modo, en la consulta del ejercicio anterior, hemos visto que si se indica explícitamente que un campo ha de mostrarse entonces se asume que el resto de campos se excluyen.

```JavaScript
db.pedidos.find(
  {Localidad : {$in : ["Jaen", "Salamanca"]}},
  {Pedidos : false}
)
```

El resultado de ambas consultas es el siguiente:

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3780"), "id_cliente" : 2222, "Nombre" : "Juan Gomez", "Direccion" : "Perpetuo Socorro 9", "Localidad" : "Salamanca", "Fnacimiento" : ISODate("1960-08-17T00:00:00Z"), "Facturacion" : 6500 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3781"), "id_cliente" : 3333, "Nombre" : "Carlos Montes", "Direccion" : "Salsipuedes 13", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1967-11-25T00:00:00Z"), "Facturacion" : 8000 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3782"), "id_cliente" : 4444, "Nombre" : "Carmelo Coton", "Direccion" : "La Luna 103", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1969-01-06T00:00:00Z"), "Facturacion" : 12300 }
```

### 6. Visualiza los clientes que no tienen campo pedidos.

En esta ocasión vamos a hacer uso del operador `$exists` que nos permite obtener sólo los documentos que contienen o no contienen un determinado campo, según el valor booleano que le demos:

```JavaScript
db.pedidos.find(
  {Pedidos : {$exists : false}}
)
```
Con eso obtenemos el siguiente resultado, observemos que el cliente con identificador **7777** no aparece ya que, aunque su array de pedidos es null, sí que contiene este campo:

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3781"), "id_cliente" : 3333, "Nombre" : "Carlos Montes", "Direccion" : "Salsipuedes 13", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1967-11-25T00:00:00Z"), "Facturacion" : 8000 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3782"), "id_cliente" : 4444, "Nombre" : "Carmelo Coton", "Direccion" : "La Luna 103", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1969-01-06T00:00:00Z"), "Facturacion" : 12300 }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3784"), "id_cliente" : 6666, "Nombre" : "Chema Pamundi", "Direccion" : "Recogidas 54", "Localidad" : "Granada", "Fnacimiento" : ISODate("1969-02-04T00:00:00Z"), "Facturacion" : 5000 }
```

### 7. Visualiza los clientes que hayan nacido en 1963.

```JavaScript
db.pedidos.find(
	{Fnacimiento : {$gte : new Date(1963, 1, 1), $lte : new Date(1963, 12, 31)}	}
)
```
Con esta consulta vemos que sólo hay un cliente que haya nacido en ese año:

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb377f"), "id_cliente" : 1111, "Nombre" : "Pedro Ramirez", "Direccion" : "Calle Los Romeros 14", "Localidad" : "Sevilla", "Fnacimiento" : ISODate("1963-04-03T00:00:00Z"), "Facturacion" : 5000, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 390, "Cantidad" : 1 }, { "id_producto" : 2, "Nombre" : "Tablet 8 pulgadas", "Precio_unidad" : 95, "Cantidad" : 1 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 115, "Cantidad" : 3 } ] } ] }
```

Se intentó usar el método `aggregate` pero esto no devuelve un resultado de una consulta, lo que devuelve es un nuevo documento. Ya trabajaremos con este método en la [siguiente sección](#objetivo2).

### 8. Visualiza los clientes que hayan pedido algún producto fabricado por Canon y algún producto cuyo precio sea inferior a 15 euros.

```JavaScript
db.pedidos.find(
  {$and : [
		{Pedidos :
			{$elemMatch :
				{Productos : {$elemMatch : {Precio_unidad : {$lt : 15} } } }
			}},
		{Pedidos :
			{$elemMatch :
				{Productos : {$elemMatch : {Fabricante : "Canon" } } }
			}}
		]
	},
	{id_cliente : true}
)
```

```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3780"), "id_cliente" : 2222 }
```

Aquí hemos observamo algo sobre el funcionamiento de las consultas en MongoDB, si en lugar de usar dos sentencias unidas por un operador `$and` intentásemos añadir un vector de claves-valor para la el campo *Pedidos* con dos operadores `$elemMatch`, entonces lo que ocurre es que al estar usando realmente la misma clave dos veces la segunda condición sobreescribe la primera.

### 9. Datos personales (id_cliente, Nombre, Direccion, Localidad y Fnacimiento) de los clientes cuyo nombre empieza por la cadena "c" (No distinguir entre mayusculas y minúsculas).

Para este ejercicio haremos uso del operador `$regex` el cuál empleamos para seleccionar los documentos en los que un campo determinado coincida con la expresión regular que deseemos, esta expresión regular seguirá [el formato de Perl](https://perldoc.perl.org/perlre.html#Regular-Expressions).

```JavaScript
db.pedidos.find(
	{Nombre : {$regex : /^c|C/}},
	{id_cliente : true, Nombre : true, Direccion : true, Localidad : true, Fnacimiento : true}
)
```
```JavaScript
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3781"), "id_cliente" : 3333, "Nombre" : "Carlos Montes", "Direccion" : "Salsipuedes 13", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1967-11-25T00:00:00Z") }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3782"), "id_cliente" : 4444, "Nombre" : "Carmelo Coton", "Direccion" : "La Luna 103", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1969-01-06T00:00:00Z") }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3783"), "id_cliente" : 5555, "Nombre" : "Cristina Miralles", "Direccion" : "San Fernando 28", "Localidad" : "Granada", "Fnacimiento" : ISODate("1970-07-12T00:00:00Z") }
{ "_id" : ObjectId("58ff8df7dcc0e5e22fdb3784"), "id_cliente" : 6666, "Nombre" : "Chema Pamundi", "Direccion" : "Recogidas 54", "Localidad" : "Granada", "Fnacimiento" : ISODate("1969-02-04T00:00:00Z") }
```

### 10. Visualiza los datos personales de los clientes (excluyendo \_id). Limita los documentos a 4.

Para este ejercicio no tenos más que convinar cosas que ya hemos venido usando en ejercicios anteriores, así la consulta quedaría como se muestra a continuación, junto con su salida. Observamos como antes, aunque no especificásemos explícitamente que se mostrase el campo `_id` este se mostraba, con lo cual MongoDB hace una distinción entre los campos de un documento y los que se construyen por defecto sobre él; como es este ID de objeto.

```JavaScript
db.pedidos.find(
	{},
	{_id : false}
).limit(4)
```

```JavaScript
{ "id_cliente" : 1111, "Nombre" : "Pedro Ramirez", "Direccion" : "Calle Los Romeros 14", "Localidad" : "Sevilla", "Fnacimiento" : ISODate("1963-04-03T00:00:00Z"), "Facturacion" : 5000, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 390, "Cantidad" : 1 }, { "id_producto" : 2, "Nombre" : "Tablet 8 pulgadas", "Precio_unidad" : 95, "Cantidad" : 1 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 115, "Cantidad" : 3 } ] } ] }
{ "id_cliente" : 2222, "Nombre" : "Juan Gomez", "Direccion" : "Perpetuo Socorro 9", "Localidad" : "Salamanca", "Fnacimiento" : ISODate("1960-08-17T00:00:00Z"), "Facturacion" : 6500, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 100, "Cantidad" : 1 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Fabricante" : "Intel", "Precio_unidad" : 455, "Cantidad" : 2 }, { "id_producto" : 27, "Nombre" : "Cable USB", "Precio_unidad" : 11, "Cantidad" : 12 } ] }, { "id_pedido" : 2, "Productos" : [ { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 128, "Cantidad" : 3 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Fabricante" : "Intel", "Precio_unidad" : 451, "Cantidad" : 5 }, { "id_producto" : 21, "Nombre" : "Disco Duro 500GB", "Precio_unidad" : 99, "Cantidad" : 10 } ] }, { "id_pedido" : 3, "Productos" : [ { "id_producto" : 1, "Nombre" : "Pentium IV", "Fabricante" : "Intel", "Precio_unidad" : 94, "Cantidad" : 5 }, { "id_producto" : 95, "Nombre" : "SAI 5H Mod. 258", "Precio_unidad" : 213, "Cantidad" : 2 }, { "id_producto" : 21, "Precio_unidad" : 66, "Nombre" : "Disco Duro 500GB", "Cantidad" : 10 } ] } ] }
{ "id_cliente" : 3333, "Nombre" : "Carlos Montes", "Direccion" : "Salsipuedes 13", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1967-11-25T00:00:00Z"), "Facturacion" : 8000 }
{ "id_cliente" : 4444, "Nombre" : "Carmelo Coton", "Direccion" : "La Luna 103", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1969-01-06T00:00:00Z"), "Facturacion" : 12300 }
```
### 11. Ídem anterior pero ordenando los documentos por Localidad (ascendente) e id_cliente (descendente).

Para esto simplemente hacemos uso de la función `sort` que nos permite ordenar el resultado de una consulta sobre una determinada colección. Para ello le pasamos como argumento un array asociativo de pares donde la clave es un campo que elegimos para ordenar el resultado y el valor es 1 o -1 dependiendo de si queremos ordenar para ese campo de forma ascendente o descendente, respectivamente.

Señalar que también existe el operador `$orderby` pero este está declarado obsoleto desde la versión 3.2 de la Mongo shell, con lo cual preferimos emplear una opción actual.

```JavaScript
db.pedidos.find(
	{},
	{_id : false}
).limit(4).sort({Localidad : 1, id_cliente : -1})
```

```JavaScript
{ "id_cliente" : 6666, "Nombre" : "Chema Pamundi", "Direccion" : "Recogidas 54", "Localidad" : "Granada", "Fnacimiento" : ISODate("1969-02-04T00:00:00Z"), "Facturacion" : 5000 }
{ "id_cliente" : 5555, "Nombre" : "Cristina Miralles", "Direccion" : "San Fernando 28", "Localidad" : "Granada", "Fnacimiento" : ISODate("1970-07-12T00:00:00Z"), "Facturacion" : 16500, "Pedidos" : [ { "id_pedido" : 1, "Productos" : [ { "id_producto" : 95, "Nombre" : "SAI 5H Mod. 258", "Precio_unidad" : 211, "Cantidad" : 2 }, { "id_producto" : 42, "Nombre" : "Portatil ASM Mod. 254", "Precio_unidad" : 460, "Fabricante" : "Intel", "Cantidad" : 2 }, { "id_producto" : 77, "Nombre" : "Impresora Laser", "Fabricante" : "Canon", "Precio_unidad" : 119, "Cantidad" : 2 } ] } ] }
{ "id_cliente" : 4444, "Nombre" : "Carmelo Coton", "Direccion" : "La Luna 103", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1969-01-06T00:00:00Z"), "Facturacion" : 12300 }
{ "id_cliente" : 3333, "Nombre" : "Carlos Montes", "Direccion" : "Salsipuedes 13", "Localidad" : "Jaen", "Fnacimiento" : ISODate("1967-11-25T00:00:00Z"), "Facturacion" : 8000 }
```
## Objetivo2

### 1. Nº total de clientes.

No necesitamos realizar en esta ocasión ningún preprocesamiento de la colección original, con lo cual no pasamos por ninguna otra fase de la agregación y vamos directamente a la de conteo. Para ello empleamos el operador `$count` indicándole en un string el nombre del campo, de la colección resultante, en la que se almacenará el conteo; en este caso el número de clientes de la colección.

```JavaScript
db.pedidos.aggregate(
	[
		{$count : "nClientes"}
	]
)
```

```JavaScript
{ "nClientes" : 7 }
```

### 2. No total de clientes de Jaén.

En esta ocasión lo que hacemos previamente es una fase de *mathing* que podríamos considerar equivalente a emplear el método `find` para filtrar los documentos de la colección original.

```JavaScript
db.pedidos.aggregate(
	[
		{$match : {Localidad : "Jaen"}},
		{$count : "nClientes"}
	]
)
```

```JavaScript
{ "nClientes" : 2 }
```

### 3. Facturación total de clientes por localidad.

En esta ocasión pasamos por una fase de agrupamiento con el operador `$group`. Le damos por un lado los campos que tendrá el ID de cada grupo, y por tanto los campos por los que se agrupan los distintos documentos de la colección original. Y por otro lado los campos del documento que se genera con algún operador de acumulación a aplicar sobre un campo determinado de todos los documentos de la colección de entrada que pertenecen a un mismo grupo.

```JavaScript
db.pedidos.aggregate(
	[
		{$group : {
			_id : {localidad : "$Localidad"},
			facturacionTotal : {$sum : "$Facturacion"}
		}}
	]
)
```

```JavaScript
{ "_id" : { "localidad" : "Granada" }, "facturacionTotal" : 21500 }
{ "_id" : { "localidad" : "Jaen" }, "facturacionTotal" : 20300 }
{ "_id" : { "localidad" : "Salamanca" }, "facturacionTotal" : 6500 }
{ "_id" : { "localidad" : "Sevilla" }, "facturacionTotal" : 7500 }
```

### 4. Facturación media de clientes por localidad para las localidades distintas a "Jaen" con facturación media mayor de 5000. Ordenación por Localidad descendente. Eliminar el \_id y poner el nombre en mayúsculas.

```JavaScript
db.pedidos.aggregate(
	[
		{$match : {Localidad : {$not : /Jaen/}}},
		{$group : {
			_id : "$Localidad",
			facturacionMedia : {$avg : "$Facturacion"}
		}},
		{$match : {facturacionMedia : {$gt : 5000}}},
		{$sort : {_id : -1}},
		{$project : {nombreLocalidad : {$toUpper : "$_id"}, _id : false, facturacionMedia : true}}
	]
)
```

```JavaScript
{ "facturacionMedia" : 6500, "nombreLocalidad" : "SALAMANCA" }
{ "facturacionMedia" : 10750, "nombreLocalidad" : "GRANADA" }
```

### 5. Calcula la cantidad total facturada por cada cliente (uso de “unwind”).

```JavaScript
db.pedidos.aggregate(
	[
		{$project : {id_cliente : true, Nombre : true, Pedidos : true}},
		{$unwind : "$Pedidos"},
		{$unwind : "$Pedidos.Productos"},
		{$group : {
			_id : {id_cliente : "$id_cliente", nombre : "$Nombre"},
			facturacionTotal : {$sum : {$multiply : ["$Pedidos.Productos.Precio_unidad", "$Pedidos.Productos.Cantidad"]}}
		}}
	]
)
```
Podríamos pensar en volver a hacer un `$unwind` del atributo `Pedidos` pero esto no funcionaría correctamente, lo que hace unwind es separar en varios documentos los elementos de un array no de un array asociado, con lo que realizar esta acción de nuevo nos daría el mismo resultado que realizar la tarea una sola vez, ya que haro el campo `Pedidos` de cada documento es un array asociado y no un array.

```JavaScript
{ "_id" : { "id_cliente" : 5555, "nombre" : "Cristina Miralles" }, "facturacionTotal" : 1580 }
{ "_id" : { "id_cliente" : 2222, "nombre" : "Juan Gomez" }, "facturacionTotal" : 6327 }
{ "_id" : { "id_cliente" : 1111, "nombre" : "Pedro Ramirez" }, "facturacionTotal" : 830 }
```

## Objetivo3

Para copiar el archivo CSV desde el host al contenedor lo que hacemos, desde el directorio **/tmp/mongo** ejecutar el comando siguiente: `docker exec -i mongo_griger sh -c 'cat > /data/db/Cities.csv' < Cities.csv`. Luego y ya dentro del contenedor, en el directorio donde hemos almacenado el CSV con la colección ejecutamos la orden `mongoimport --db test --collection cities --type csv --headerline --file Cities.csv`.

### 1. Encontrar las ciudades más cercanas sobre la colección recién creada mediante un enfoque MapReduce conforme a los pasos que se ilustran en el tutorial práctico.

```JavaScript
var mapCode = function MapCode() {
	emit(this.CountryID,
		{ "data":
			[
				{
					"name": this.City,
					"lat": this.Latitude,
					"lon": this.Longitude
				}
			]
	});
}
```

```JavaScript
var reduceCode = function ReduceCode(key, values) {
	var reduced = {"data":[]};
	for (var i in values) {
		var inter = values[i];
		for (var j in inter.data) {
			reduced.data.push(inter.data[j]);
		}
	}
	return reduced;
}
```

```JavaScript
var finalize = function Finalize(key, reduced) {
	if (reduced.data.length == 1) {
		return { "message" : "Este pais solo contiene una ciudad" };
	}

	var min_dist = 999999999999;
	var city1 = { "name": "" };
	var city2 = { "name": "" };
	var c1;
	var c2;
	var d2;

	for (var i in reduced.data) {
		for (var j in reduced.data) {
			if (i>=j) continue;
			c1 = reduced.data[i];
			c2 = reduced.data[j];
			d2 = (c1.lat-c2.lat)*(c1.lat-c2.lat)+(c1.lon-c2.lon)*(c1.lon-c2.lon);

			if (d2 < min_dist && d2 > 0) {
				min_dist = d2;
				city1 = c1;
				city2 = c2;
			}
		}
	}
	return {"city1": city1.name, "city2": city2.name, "dist": Math.sqrt(min_dist)};
}
```

```JavaScript
db.runCommand({
	mapReduce : "cities",
	map : mapCode,
	reduce : reduceCode,
	finalize : finalize,
	query : { "CountryID" : { "$ne" : 254 } },
	out: { merge: "ciudades_proximas" }
})
```
Con esto obtenemos el siguiente resultado, mostramos sólo la sección de la salida en que aparece, entre otros, el resultado para España:

```JavaScript
{ "_id" : 75, "value" : { "city1" : "saue", "city2" : "Tallinn", "dist" : 0.20885641000457617 } }
{ "_id" : 76, "value" : { "city1" : "Axum", "city2" : "Addis Ababa", "dist" : 5.10002833325463 } }
{ "_id" : 79, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 80, "value" : { "city1" : "Nailuva", "city2" : "Suva", "dist" : 0.6116281550092378 } }
{ "_id" : 81, "value" : { "city1" : "Tapiola", "city2" : "Vantaa", "dist" : 0.1314193669137066 } }
{ "_id" : 82, "value" : { "city1" : "Colombes", "city2" : "Courbevoic", "dist" : 0.016600000000003945 } }
{ "_id" : 84, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 85, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 87, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 88, "value" : { "city1" : "Banjul", "city2" : "Kanifing", "dist" : 0.0980815986819128 } }
{ "_id" : 90, "value" : { "city1" : "Tbilisi", "city2" : "Mtskheta", "dist" : 0.17577613603672304 } }
{ "_id" : 91, "value" : { "city1" : "Ludwigshafen Am Rhein", "city2" : "Mannheim", "dist" : 0.020591260281973632 } }
{ "_id" : 92, "value" : { "city1" : "Accra", "city2" : "Tema", "dist" : 0.21092415698539613 } }
{ "_id" : 93, "value" : { "city1" : "Algeciras", "city2" : "La Linea", "dist" : 0.003162277660168312 } }
{ "_id" : 95, "value" : { "city1" : "Athens", "city2" : "Peristérion", "dist" : 0.04738143096193373 } }
{ "_id" : 96, "value" : { "city1" : "Nuuk", "city2" : "Upernavik", "dist" : 9.679723544089475 } }
{ "_id" : 97, "value" : { "city1" : "St George's", "city2" : "Hillsborough", "dist" : 0.5116606394867611 } }
{ "_id" : 98, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 99, "value" : { "city1" : "Maite", "city2" : "Tamuning", "dist" : 0.01592607924127576 } }
{ "_id" : 100, "value" : { "city1" : "SAN MIGUEL PETAPA", "city2" : "VILLA CANALES", "dist" : 0.038013155617488865 } }
```
### 2. ¿Cómo podríamos obtener las ciudades más distantes en cada país?

Simplemente tendríamos que hacer un pequeño ajuste a la función de la fase `reduce` para que busque la pareja de ciudades más distantes en lugar de las más cercanas:

```JavaScript
var finalize = function Finalize(key, reduced) {
	if (reduced.data.length == 1) {
		return { "message" : "Este pais solo contiene una ciudad" };
	}

	var max_dis = 0;
	var city1 = { "name": "" };
	var city2 = { "name": "" };
	var c1;
	var c2;
	var d2;

	for (var i in reduced.data) {
		for (var j in reduced.data) {
			if (i>=j) continue;
			c1 = reduced.data[i];
			c2 = reduced.data[j];
			d2 = (c1.lat-c2.lat)*(c1.lat-c2.lat)+(c1.lon-c2.lon)*(c1.lon-c2.lon);

			if (d2 > max_dis) {
				max_dist = d2;
				city1 = c1;
				city2 = c2;
			}
		}
	}
	return {"city1": city1.name, "city2": city2.name, "dist": Math.sqrt(max_dist)};
}
```

Cambiamos levemente el comando para lanzar el MapReduce de modo que se guarde el resultado en una colección distinta a la anterior:

```JavaScript
db.runCommand({
	mapReduce : "cities",
	map : mapCode,
	reduce : reduceCode,
	finalize : finalize,
	query : { "CountryID" : { "$ne" : 254 } },
	out: { merge: "ciudades_distantes" }
})
```

En en el siguiente fragmento de la salida de esta función vemos como, para España, las ciudades más alejadas son Marbella y La Línea. Señalar que las ciudades de España en la colección que hemos cargado para realizar este objetivo son: Algeciras, Estepona, Gibraltar, La Línea y Marbella.

```JavaScript
{ "_id" : 75, "value" : { "city1" : "Tartu", "city2" : "Viljandi", "dist" : 1.14600174519937 } }
{ "_id" : 76, "value" : { "city1" : "Axum", "city2" : "Addis Ababa", "dist" : 5.10002833325463 } }
{ "_id" : 79, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 80, "value" : { "city1" : "Nailuva", "city2" : "Suva", "dist" : 0.6116281550092378 } }
{ "_id" : 81, "value" : { "city1" : "Valkeakoski", "city2" : "Raahe", "dist" : 3.4455124437447653 } }
{ "_id" : 82, "value" : { "city1" : "Strasbourg", "city2" : "Nimes", "dist" : 5.834881953467438 } }
{ "_id" : 84, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 85, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 87, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 88, "value" : { "city1" : "Banjul", "city2" : "Kanifing", "dist" : 0.0980815986819128 } }
{ "_id" : 90, "value" : { "city1" : "Mtskheta", "city2" : "P'ot'I", "dist" : 3.064718584144395 } }
{ "_id" : 91, "value" : { "city1" : "AOL", "city2" : "Lauf", "dist" : 2.722384616471374 } }
{ "_id" : 92, "value" : { "city1" : "Bolgatanga", "city2" : "Ga District", "dist" : 1.0455410082823144 } }
{ "_id" : 93, "value" : { "city1" : "La Linea", "city2" : "Marbella", "dist" : 0.003162277660168312 } }
{ "_id" : 95, "value" : { "city1" : "Mytilini", "city2" : "Larisa", "dist" : 4.1698196603690185 } }
{ "_id" : 96, "value" : { "city1" : "Nuuk", "city2" : "Upernavik", "dist" : 9.679723544089475 } }
{ "_id" : 97, "value" : { "city1" : "St George's", "city2" : "Hillsborough", "dist" : 0.5116606394867611 } }
{ "_id" : 98, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 99, "value" : { "city1" : "Yigo", "city2" : "Yona", "dist" : 0.1679865768446987 } }
{ "_id" : 100, "value" : { "city1" : "ZACAPA", "city2" : "Huehuetenango", "dist" : 1.9698865449563356 } }
```

### 3. ¿Qué ocurre si en un país hay dos parejas de ciudades que están a la misma distancia mínima? ¿Cómo harías para que aparecieran todas?

Con el código que tenemos anteriormente lo que ocurre es que sólo se va a mostrar la primera pareja de ciudades que estén a dicha distancia mínima. La función `finalize` es la que tenemos que modificar de modo que lo que devuelva, por cada país, sea un array asociativo donde haya por cada pareja un atributo clave-valor con la clave un identificador para la pareja y como valor los datos de esa pareja en particular.

```JavaScript
var finalize = function Finalize(key, reduced) {
	if (reduced.data.length == 1) {
		return { "message" : "Este pais solo contiene una ciudad" };
	}

	var min_dist = 999999999999;
	var pair_list = {};
	var contador = 0;
	var c1;
	var c2;
	var d2;

	for (var i in reduced.data) {
		for (var j in reduced.data) {
			if (i>=j) continue;
			c1 = reduced.data[i];
			c2 = reduced.data[j];
			d2 = (c1.lat-c2.lat)*(c1.lat-c2.lat)+(c1.lon-c2.lon)*(c1.lon-c2.lon);

			if (d2 < min_dist && d2 > 0) {
				pair_list = {};
				contador = 0;
				min_dist = d2;
				pair_list["pair" + contador] = {"city1": c1.name, "city2": c2.name, "dist": Math.sqrt(min_dist)};
			}
			else if (d2 == min_dist) {
				contador++;
				pair_list["pair" + contador] = {"city1": c1.name, "city2": c2.name, "dist": Math.sqrt(min_dist)};
			}
		}
	}
	return pair_list;
}
```
Entonces, con el mismo comando `runCommand` de antes, obtenemos lo siguiente:

```JavaScript
{ "_id" : 75, "value" : { "pair0" : { "city1" : "saue", "city2" : "Tallinn", "dist" : 0.20885641000457617 } } }
{ "_id" : 76, "value" : { "pair0" : { "city1" : "Axum", "city2" : "Addis Ababa", "dist" : 5.10002833325463 } } }
{ "_id" : 79, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 80, "value" : { "pair0" : { "city1" : "Nailuva", "city2" : "Suva", "dist" : 0.6116281550092378 } } }
{ "_id" : 81, "value" : { "pair0" : { "city1" : "Tapiola", "city2" : "Vantaa", "dist" : 0.1314193669137066 } } }
{ "_id" : 82, "value" : { "pair0" : { "city1" : "Colombes", "city2" : "Courbevoic", "dist" : 0.016600000000003945 } } }
{ "_id" : 84, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 85, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 87, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 88, "value" : { "pair0" : { "city1" : "Banjul", "city2" : "Kanifing", "dist" : 0.0980815986819128 } } }
{ "_id" : 90, "value" : { "pair0" : { "city1" : "Tbilisi", "city2" : "Mtskheta", "dist" : 0.17577613603672304 } } }
{ "_id" : 91, "value" : { "pair0" : { "city1" : "Ludwigshafen Am Rhein", "city2" : "Mannheim", "dist" : 0.020591260281973632 } } }
{ "_id" : 92, "value" : { "pair0" : { "city1" : "Accra", "city2" : "Tema", "dist" : 0.21092415698539613 } } }
{ "_id" : 93, "value" : { "pair0" : { "city1" : "Algeciras", "city2" : "La Linea", "dist" : 0.003162277660168312 }, "pair1" : { "city1" : "Estepona", "city2" : "La Linea", "dist" : 0.003162277660168312 }, "pair2" : { "city1" : "Gibraltar", "city2" : "La Linea", "dist" : 0.003162277660168312 }, "pair3" : { "city1" : "La Linea", "city2" : "Marbella", "dist" : 0.003162277660168312 } } }
{ "_id" : 95, "value" : { "pair0" : { "city1" : "Athens", "city2" : "Peristérion", "dist" : 0.04738143096193373 } } }
{ "_id" : 96, "value" : { "pair0" : { "city1" : "Nuuk", "city2" : "Upernavik", "dist" : 9.679723544089475 } } }
{ "_id" : 97, "value" : { "pair0" : { "city1" : "St George's", "city2" : "Hillsborough", "dist" : 0.5116606394867611 } } }
{ "_id" : 98, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 99, "value" : { "pair0" : { "city1" : "Maite", "city2" : "Tamuning", "dist" : 0.01592607924127576 } } }
{ "_id" : 100, "value" : { "pair0" : { "city1" : "SAN MIGUEL PETAPA", "city2" : "VILLA CANALES", "dist" : 0.038013155617488865 } } }
```

### 4. ¿Cómo podríamos obtener adicionalmente la cantidad de parejas de ciudades evaluadas para cada país consultado?.

```JavaScript
var finalize = function Finalize(key, reduced) {
	if (reduced.data.length == 1) {
		return { "message" : "Este pais solo contiene una ciudad" };
	}

	var min_dist = 999999999999;
	var contador = 0;
	var city1 = { "name": "" };
	var city2 = { "name": "" };
	var c1;
	var c2;
	var d2;

	for (var i in reduced.data) {
		for (var j in reduced.data) {
			if (i>=j) continue;
			contador++;
			c1 = reduced.data[i];
			c2 = reduced.data[j];
			d2 = (c1.lat-c2.lat)*(c1.lat-c2.lat)+(c1.lon-c2.lon)*(c1.lon-c2.lon);

			if (d2 < min_dist && d2 > 0) {
				min_dist = d2;
				city1 = c1;
				city2 = c2;
			}
		}
	}
	return {"city1": city1.name, "city2": city2.name, "dist": Math.sqrt(min_dist), "numCiudadesEvaluadas" : contador};
}
```

```JavaScript
{ "_id" : 75, "value" : { "city1" : "saue", "city2" : "Tallinn", "dist" : 0.20885641000457617, "numCiudadesEvaluadas" : 45 } }
{ "_id" : 76, "value" : { "city1" : "Axum", "city2" : "Addis Ababa", "dist" : 5.10002833325463, "numCiudadesEvaluadas" : 1 } }
{ "_id" : 79, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 80, "value" : { "city1" : "Nailuva", "city2" : "Suva", "dist" : 0.6116281550092378, "numCiudadesEvaluadas" : 1 } }
{ "_id" : 81, "value" : { "city1" : "Tapiola", "city2" : "Vantaa", "dist" : 0.1314193669137066, "numCiudadesEvaluadas" : 1891 } }
{ "_id" : 82, "value" : { "city1" : "Colombes", "city2" : "Courbevoic", "dist" : 0.016600000000003945, "numCiudadesEvaluadas" : 17766 } }
{ "_id" : 84, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 85, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 87, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 88, "value" : { "city1" : "Banjul", "city2" : "Kanifing", "dist" : 0.0980815986819128, "numCiudadesEvaluadas" : 1 } }
{ "_id" : 90, "value" : { "city1" : "Tbilisi", "city2" : "Mtskheta", "dist" : 0.17577613603672304, "numCiudadesEvaluadas" : 10 } }
{ "_id" : 91, "value" : { "city1" : "Ludwigshafen Am Rhein", "city2" : "Mannheim", "dist" : 0.020591260281973632, "numCiudadesEvaluadas" : 61075 } }
{ "_id" : 92, "value" : { "city1" : "Accra", "city2" : "Tema", "dist" : 0.21092415698539613, "numCiudadesEvaluadas" : 36 } }
{ "_id" : 93, "value" : { "city1" : "Algeciras", "city2" : "La Linea", "dist" : 0.003162277660168312, "numCiudadesEvaluadas" : 10 } }
{ "_id" : 95, "value" : { "city1" : "Athens", "city2" : "Peristérion", "dist" : 0.04738143096193373, "numCiudadesEvaluadas" : 946 } }
{ "_id" : 96, "value" : { "city1" : "Nuuk", "city2" : "Upernavik", "dist" : 9.679723544089475, "numCiudadesEvaluadas" : 3 } }
{ "_id" : 97, "value" : { "city1" : "St George's", "city2" : "Hillsborough", "dist" : 0.5116606394867611, "numCiudadesEvaluadas" : 1 } }
{ "_id" : 98, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 99, "value" : { "city1" : "Maite", "city2" : "Tamuning", "dist" : 0.01592607924127576, "numCiudadesEvaluadas" : 45 } }
{ "_id" : 100, "value" : { "city1" : "SAN MIGUEL PETAPA", "city2" : "VILLA CANALES", "dist" : 0.038013155617488865, "numCiudadesEvaluadas" : 231 } }
```
Como podemos ver el resultado para España, por ejemplo, es correcto. Tenemos cinco ciudades con lo que se realizan, efectivamente, 10 evaluaciones distintas.

### 5. ¿Cómo podríamos la distancia media entre las ciudades de cada país?.

```JavaScript
var finalize = function Finalize(key, reduced) {
	if (reduced.data.length == 1) {
		return { "message" : "Este pais solo contiene una ciudad" };
	}

	var min_dist = 999999999999;
	var contador = 0;
	var sumDistancias = 0;
	var city1 = { "name": "" };
	var city2 = { "name": "" };
	var c1;
	var c2;
	var d2;

	for (var i in reduced.data) {
		for (var j in reduced.data) {
			if (i>=j) continue;
			contador++;
			c1 = reduced.data[i];
			c2 = reduced.data[j];
			d2 = (c1.lat-c2.lat)*(c1.lat-c2.lat)+(c1.lon-c2.lon)*(c1.lon-c2.lon);
			sumDistancias += d2;

			if (d2 < min_dist && d2 > 0) {
				min_dist = d2;
				city1 = c1;
				city2 = c2;
			}
		}
	}
	return {"city1": city1.name, "city2": city2.name, "dist": Math.sqrt(min_dist), "numCiudadesEvaluadas" : contador, "distanciaMedia" : sumDistancias * 1.0 / contador};
}
```
```JavaScript
{ "_id" : 75, "value" : { "city1" : "saue", "city2" : "Tallinn", "dist" : 0.20885641000457617, "numCiudadesEvaluadas" : 45, "distanciaMedia" : 3.639066266666666 } }
{ "_id" : 76, "value" : { "city1" : "Axum", "city2" : "Addis Ababa", "dist" : 5.10002833325463, "numCiudadesEvaluadas" : 1, "distanciaMedia" : 26.010288999999997 } }
{ "_id" : 79, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 80, "value" : { "city1" : "Nailuva", "city2" : "Suva", "dist" : 0.6116281550092378, "numCiudadesEvaluadas" : 1, "distanciaMedia" : 0.37408900000000433 } }
{ "_id" : 81, "value" : { "city1" : "Tapiola", "city2" : "Vantaa", "dist" : 0.1314193669137066, "numCiudadesEvaluadas" : 1891, "distanciaMedia" : 16.140272254093066 } }
{ "_id" : 82, "value" : { "city1" : "Colombes", "city2" : "Courbevoic", "dist" : 0.016600000000003945, "numCiudadesEvaluadas" : 17766, "distanciaMedia" : 48.36229668894773 } }
{ "_id" : 84, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 85, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 87, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 88, "value" : { "city1" : "Banjul", "city2" : "Kanifing", "dist" : 0.0980815986819128, "numCiudadesEvaluadas" : 1, "distanciaMedia" : 0.009619999999999797 } }
{ "_id" : 90, "value" : { "city1" : "Tbilisi", "city2" : "Mtskheta", "dist" : 0.17577613603672304, "numCiudadesEvaluadas" : 10, "distanciaMedia" : 6.972227238000018 } }
{ "_id" : 91, "value" : { "city1" : "Ludwigshafen Am Rhein", "city2" : "Mannheim", "dist" : 0.020591260281973632, "numCiudadesEvaluadas" : 61075, "distanciaMedia" : 58.51979168577017 } }
{ "_id" : 92, "value" : { "city1" : "Accra", "city2" : "Tema", "dist" : 0.21092415698539613, "numCiudadesEvaluadas" : 36, "distanciaMedia" : 12.35686092468889 } }
{ "_id" : 93, "value" : { "city1" : "Algeciras", "city2" : "La Linea", "dist" : 0.003162277660168312, "numCiudadesEvaluadas" : 10, "distanciaMedia" : 0.0000039999999999998296 } }
{ "_id" : 95, "value" : { "city1" : "Athens", "city2" : "Peristérion", "dist" : 0.04738143096193373, "numCiudadesEvaluadas" : 946, "distanciaMedia" : 11.947757321987309 } }
{ "_id" : 96, "value" : { "city1" : "Nuuk", "city2" : "Upernavik", "dist" : 9.679723544089475, "numCiudadesEvaluadas" : 3, "distanciaMedia" : 5113.071169926668 } }
{ "_id" : 97, "value" : { "city1" : "St George's", "city2" : "Hillsborough", "dist" : 0.5116606394867611, "numCiudadesEvaluadas" : 1, "distanciaMedia" : 0.2617966100000013 } }
{ "_id" : 98, "value" : { "message" : "Este pais solo contiene una ciudad" } }
{ "_id" : 99, "value" : { "city1" : "Maite", "city2" : "Tamuning", "dist" : 0.01592607924127576, "numCiudadesEvaluadas" : 45, "distanciaMedia" : 7515.966550470223 } }
{ "_id" : 100, "value" : { "city1" : "SAN MIGUEL PETAPA", "city2" : "VILLA CANALES", "dist" : 0.038013155617488865, "numCiudadesEvaluadas" : 231, "distanciaMedia" : 1.1734354545454586 } }
```

### 6. ¿Mejoraría el rendimiento si creamos un índice? ¿Sobre que campo? Comprobadlo.

Las funciones `reduce` y `finalize` no van a verse beneficiadas de ningún modo por la creación de un índice, lo único que hacen es recorrer el conjunto completo de datos que les llega como parámetro y hacer una operación sobre cada elemento del mismo. Con lo cual, si quisiéramos optimizar el rendimiento del proceso MapReduce por medio de la creación de un índice tendría que ser centrándonos en la función `map`. Con lo cual el índice habrá que crearlo sobre el campo `CountryID` que es el que se emplea para realizar el mapeo de los datos.

```JavaScript
db.cities.ensureIndex({CountryID : 1})
```

Resultado con índice:

```JavaScript
{
	"result" : "ciudades_proximas",
	"timeMillis" : 1345,
	"counts" : {
		"input" : 7042,
		"emit" : 7042,
		"reduce" : 260,
		"output" : 214
	},
	"ok" : 1
}
```

Resultado sin índice:

```JavaScript
{
	"result" : "ciudades_proximas",
	"timeMillis" : 1482,
	"counts" : {
		"input" : 7042,
		"emit" : 7042,
		"reduce" : 260,
		"output" : 214
	},
	"ok" : 1
}
```

Como podemos ver la diferencia es de sólo 100 ms con lo que en este caso no se trata de una mejora destacable, probablemente por la naturaleza de la función de `map`.

## Enlaces consultados

* [La versión de Docker no permite usar docker cp para copiar archivos del host al contenedor](http://stackoverflow.com/questions/39397831/docker-cp-error-path-not-specified)
* [Ejemplos mapreduce con MongoDB](http://thejackalofjavascript.com/mapreduce-in-mongodb)
* [El operador $orderby está obsoleto](https://docs.mongodb.com/manual/reference/operator/meta/orderby/)
